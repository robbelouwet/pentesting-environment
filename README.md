# Description
A docker-compose.yml file building a pentesting environment based on kalilinux/kali-rolling using kali-tools-top10. Second container is a postgresql for msfdb.
Shared is a directory mounted at ~/shared on both containers (see docker-compose.yml).
The kali service has a persistent named volume, mounted at ~/workdir.
The postgres service also has a persistent /var/lib/postgresql/data folder where its data is stored.

# How to run
1. Prepare the xhost to run a GUIT app from this container
run this on the host:
```bash
# xhost local:root
```
2. Perform an ssh-keygen, move/rename the public key to copy-files/id_rsa_host.pub.
3. Move/rename private key to ~/.ssh/id_rsa_host.
4. Optionally you can download a .ovpn file (for HackTheBox for example) and place it in copy-files. kali-dockerfile will automatically copy it to /config.ovpn in kali container. When inside this container do ./connect.
5. docker-compose up

# Kali service
This runs an ssh service, you can connect using the keys as specified above. Firefox should be working in this container

-> It's best to create a host in the host's /etc/ssh/ssh_config.
Example:
```bash
Host kali
        hostName localhost
        User root
        # container portmapping is 222:22
        Port 222
        IdentityFile /path/to/private_key # see [How to run](How to run)
        # specify these lines to disable host key checking,
        # necessary because ever container startup results
        # in different host key associated with this host
        StrictHostKeyChecking no
        UserKnownHostsFile=/dev/null
```

# Remarks
* Do not do msfdb reinit, this will override /usr/share/metasploit-framework/config/database.yml which contains connection data to the postgresql container.
* If you look at the kali dockerfile, notice a github repo is pulled and copied into the image layer. This was a fix for systemd not being PID 1 in the container.
This isn't necessary anymore, but I'm leaving it cause it works. Use it like you would use systemctl normally.
* If you don't plan to use openvpn and don't have a .ovpn pack in /shared, comment out the corresponding COPY line in the kali dockerfile.
If you execute /connect.sh though, it will give an error (file not found).
* docker-postgresql-multiple-databases contains an entrypoint script to create multiple databases in the postgresql container (msf needs both msf and msf_test).
postgres documentation: *After the entrypoint calls `initdb` to create the default `postgres` user and database,
it will run any `*.sql` files and source any `*.sh` scripts found in that
directory to do further initialization before starting the service.* Which is where this script is mounted.
* GUI: To make the GUI work, I've done 4 things:
  - The DISPLAY env variable needs to be forwarded from host to container. This works, only ssh sessions override the environment. Kali's entrypoint script takes care of this.
  - The host's XAuthorize file is mounted to the container.
  - To reuse the X magic cookie in the host's mounted Xauthorize file, the container's hostname needs to be the same as the host's hostname (substituted in docker-compose and specified in run.sh).
  - Last, you need to run ```bash # xhost local:root``` on the host in order to make the GUI work.
  Now you should be able to start /usr/lib/firefox/firefox in the container, and the GUI should pop up on the host machine. You can now browse to machines in the VPN network.
