FROM kalilinux/kali-rolling

# systemctl replacement:
ADD https://raw.githubusercontent.com/gdraheim/docker-systemctl-replacement/master/files/docker/systemctl.py /usr/local/bin/systemctl
ADD https://bootstrap.pypa.io/get-pip.py /root/get-pip.py

COPY ./copy-files/id_rsa_host.pub /root/.ssh/id_rsa_host.pub
COPY ./copy-files/database.yml /usr/share/metasploit-framework/config/database.yml

# for tshark:
ENV DEBIAN_FRONTEND=noninteractive

# RUN does 5 things:
# 1) configures ssh root login using the pub key in /root/shared and copying the key into authorized_keys
# 2) Fix the kali repository (http -> https)
# 3) creates openvpn ./connect executable using .ovpn pack in /root/shared/config.ovpn
# 4) replaces the systemctl symlink with the new systemctl replacement
# 5) install tons of packages usefull for pentesting
RUN \
    mkdir /run/sshd &&\
    dpkg --add-architecture i386 &&\
    apt-get update -y && apt-get install -y apt-utils ca-certificates ssh &&\
    echo "PubKeyAuthentication yes" >> /etc/ssh/sshd_config &&\
    cat /root/.ssh/id_rsa_host.pub >> /root/.ssh/authorized_keys &&\
    sed -i 's/http/https/' /etc/apt/sources.list &&\
    apt-get update -y && apt-get dist-upgrade -y && apt-get autoremove -y && apt-get clean -y &&\
    chmod +x /usr/local/bin/systemctl &&\
    mv /usr/bin/systemctl /usr/bin/systemctl.old &&\
    ln -s /usr/local/bin/systemctl /usr/bin/systemctl &&\
    echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config &&\
    echo -e '#!/bin/bash\nopenvpn --config /root/shared/config.ovpn --daemon' > /root/connect.sh &&\
    chmod +x /root/connect.sh &&\
    apt install -y tshark python2 lsof iputils-ping net-tools man-db exploitdb \
        openvpn nano coreutils procps vim wget curl httpie kali-tools-top10 \
        build-essential jq strace ltrace rubygems gcc dnsutils netcat \
        gcc-multilib vim gdb gdb-multiarch python python3 python3-pip \
        python3-dev libssl-dev libffi-dev git make libpcre3-dev libdb-dev \
        libxt-dev libxaw7-dev libc6:i386 libncurses5:i386 libstdc++6:i386 &&\
    python /root/get-pip.py &&\
    pip3 install 'pwntools==4.3.1' keystone-engine 'unicorn==1.0.2rc3' capstone ropper &&\
    mkdir tools && cd tools &&\
    git clone https://github.com/JonathanSalwan/ROPgadget &&\
    git clone https://github.com/radare/radare2 && cd radare2 && sys/install.sh &&\
    cd .. && git clone https://github.com/pwndbg/pwndbg && cd pwndbg && git checkout stable && sed -i 's/ python-pip / /' ./setup.sh && ./setup.sh
